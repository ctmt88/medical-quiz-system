<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫檢師題庫練習平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .controls {
            padding: 30px;
            background: white;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus {
            border-color: #667eea;
            outline: none;
        }

        .start-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .quiz-container {
            display: none;
            padding: 30px;
        }

        .question-header {
            background: #f8f9fa;
            padding: 20px;
            border-left: 5px solid #667eea;
            margin-bottom: 25px;
            border-radius: 0 10px 10px 0;
        }

        .question-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .question-text {
            font-size: 1.3em;
            line-height: 1.6;
            color: #2c3e50;
            font-weight: 500;
        }

        .options {
            margin: 25px 0;
        }

        .option {
            display: block;
            background: #f8f9fa;
            margin: 10px 0;
            padding: 15px 20px;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            line-height: 1.5;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #5a6fd8;
        }

        .option.correct {
            background: #28a745;
            color: white;
            border-color: #23923d;
        }

        .option.incorrect {
            background: #dc3545;
            color: white;
            border-color: #c82333;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .result.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.incorrect {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .explanation {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 0 5px 5px 0;
            font-style: italic;
        }

        .progress {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧬 醫檢師題庫練習</h1>
            <p>臨床血清免疫學與臨床病毒學專業題庫</p>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalQuestions">80</div>
                <div class="stat-label">總題數</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="correctCount">0</div>
                <div class="stat-label">答對</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalAnswered">0</div>
                <div class="stat-label">已答題</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="accuracy">0%</div>
                <div class="stat-label">正確率</div>
            </div>
        </div>

        <div class="controls" id="setupPanel">
            <div class="control-group">
                <label for="excelFile">📁 選擇Excel題庫檔案</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin-bottom: 15px; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9fa;">
                <div id="fileStatus" style="color: #666; font-size: 0.9em; margin-bottom: 15px;">請選擇Excel檔案載入題庫</div>
            </div>

            <div class="control-group">
                <label for="categoryFilter">選擇主題分類</label>
                <select id="categoryFilter" disabled>
                    <option value="all">請先載入Excel檔案</option>
                </select>
            </div>

            <div class="control-group">
                <label for="practiceMode">練習模式</label>
                <select id="practiceMode">
                    <option value="random">隨機出題</option>
                    <option value="sequential">順序練習</option>
                    <option value="shuffle_options">隨機選項順序</option>
                </select>
            </div>

            <button class="start-btn" onclick="startQuiz()" id="startButton" disabled style="opacity: 0.5;">請先載入Excel檔案</button>
        </div>

        <div class="quiz-container" id="quizPanel">
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="question-header">
                <div class="question-info">
                    <span id="questionNumber">第 1 題</span>
                    <span id="questionCategory">主題分類</span>
                </div>
                <div class="question-text" id="questionText"></div>
            </div>

            <div class="options" id="optionsContainer"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showAnswer()">查看答案</button>
                <button class="btn btn-primary" onclick="nextQuestion()">下一題</button>
                <button class="btn btn-secondary" onclick="backToSetup()">返回設定</button>
            </div>

            <div class="result" id="resultPanel">
                <div id="resultText"></div>
                <div class="explanation" id="explanationText" style="display: none;">
                    💡 這題目前沒有詳細解析，但你可以根據醫檢專業知識來理解答案。
                </div>
            </div>
        </div>
    </div>

    <!-- 引入SheetJS庫來讀取Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 全域變數
        let questionsData = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let showingAnswer = false;
        let stats = {
            totalAnswered: 0,
            correctCount: 0
        };

        // 處理Excel檔案上傳
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('excelFile');
            fileInput.addEventListener('change', handleFileUpload);
        });

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileStatus = document.getElementById('fileStatus');
            fileStatus.textContent = '正在讀取檔案...';
            fileStatus.style.color = '#667eea';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                questionsData = jsonData;
                
                // 更新界面
                updateCategoryOptions();
                document.getElementById('totalQuestions').textContent = questionsData.length;
                
                // 啟用控制項
                document.getElementById('categoryFilter').disabled = false;
                document.getElementById('startButton').disabled = false;
                document.getElementById('startButton').style.opacity = '1';
                document.getElementById('startButton').textContent = '開始練習';
                
                fileStatus.textContent = `✅ 成功載入 ${questionsData.length} 題！`;
                fileStatus.style.color = '#28a745';
                
            } catch (error) {
                console.error('讀取檔案失敗:', error);
                fileStatus.textContent = '❌ 檔案讀取失敗，請確認是Excel格式';
                fileStatus.style.color = '#dc3545';
            }
        }

        function updateCategoryOptions() {
            const categories = {};
            questionsData.forEach(question => {
                const category = question.主題分類 || question['主題分類'];
                if (category) {
                    categories[category] = (categories[category] || 0) + 1;
                }
            });

            const select = document.getElementById('categoryFilter');
            select.innerHTML = `<option value="all">全部主題 (${questionsData.length}題)</option>`;
            
            Object.entries(categories).forEach(([category, count]) => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${count}題)`;
                select.appendChild(option);
            });
        }

        // 初始化
        async function initializeQuestions() {
            try {
                // 嘗試從上傳的Excel讀取資料
                const fileContent = await window.fs.readFile('抽樣80題_免疫40_病毒40.xlsx');
                const workbook = XLSX.read(fileContent);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // 更新全域題庫
                questionsData.length = 0;
                questionsData.push(...jsonData);
                
                console.log('成功載入', questionsData.length, '題');
            } catch (error) {
                console.log('使用內建示例題庫');
            }
        }

        function startQuiz() {
            if (questionsData.length === 0) {
                alert('請先上傳Excel檔案！');
                return;
            }

            const category = document.getElementById('categoryFilter').value;
            const mode = document.getElementById('practiceMode').value;

            // 篩選題目
            if (category === 'all') {
                currentQuestions = [...questionsData];
            } else {
                currentQuestions = questionsData.filter(q => 
                    (q.主題分類 || q['主題分類']) === category
                );
            }

            if (currentQuestions.length === 0) {
                alert('選擇的分類沒有題目！');
                return;
            }

            // 應用模式
            if (mode === 'random') {
                shuffleArray(currentQuestions);
            } else if (mode === 'shuffle_options') {
                // 打亂選項順序但保持正確答案
                currentQuestions = currentQuestions.map(q => shuffleQuestionOptions(q));
            }

            currentQuestionIndex = 0;
            selectedAnswer = null;
            showingAnswer = false;
            
            // 重置統計
            stats = { totalAnswered: 0, correctCount: 0 };
            updateStats();

            // 切換介面
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('quizPanel').style.display = 'block';

            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                alert('所有題目都練習完了！\n' + 
                      '總題數: ' + stats.totalAnswered + '\n' +
                      '答對: ' + stats.correctCount + '\n' +
                      '正確率: ' + Math.round((stats.correctCount / stats.totalAnswered) * 100) + '%');
                backToSetup();
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            selectedAnswer = null;
            showingAnswer = false;

            // 更新進度條
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // 顯示題目資訊
            document.getElementById('questionNumber').textContent = 
                `第 ${currentQuestionIndex + 1} 題 / 共 ${currentQuestions.length} 題`;
            document.getElementById('questionCategory').textContent = 
                question.主題分類 || question['主題分類'] || '未分類';
            document.getElementById('questionText').textContent = 
                question.題目內容 || question['題目內容'] || '';

            // 顯示選項
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            ['A', 'B', 'C', 'D'].forEach(option => {
                const optionText = question['選項' + option] || question[`選項${option}`] || '';
                if (optionText) {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.textContent = `${option}) ${optionText}`;
                    optionElement.onclick = () => selectOption(option, optionElement);
                    optionsContainer.appendChild(optionElement);
                }
            });

            // 隱藏結果
            document.getElementById('resultPanel').style.display = 'none';
        }

        function selectOption(option, element) {
            if (showingAnswer) return;

            // 清除之前的選擇
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // 標記新選擇
            element.classList.add('selected');
            selectedAnswer = option;
        }

        function showAnswer() {
            if (!selectedAnswer) {
                alert('請先選擇一個答案！');
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            const correctAnswer = question.正確答案 || question['正確答案'];
            const isCorrect = selectedAnswer === correctAnswer;
            
            showingAnswer = true;

            // 更新統計
            stats.totalAnswered++;
            if (isCorrect) {
                stats.correctCount++;
            }
            updateStats();

            // 標記選項
            document.querySelectorAll('.option').forEach((opt, index) => {
                const optionLetter = ['A', 'B', 'C', 'D'][index];
                
                if (optionLetter === correctAnswer) {
                    opt.classList.add('correct');
                } else if (optionLetter === selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                
                opt.style.pointerEvents = 'none';
            });

            // 顯示結果
            const resultPanel = document.getElementById('resultPanel');
            const resultText = document.getElementById('resultText');
            
            if (isCorrect) {
                resultPanel.className = 'result correct';
                resultText.innerHTML = '🎉 答對了！';
            } else {
                const correctOptionText = question['選項' + correctAnswer] || question[`選項${correctAnswer}`];
                resultPanel.className = 'result incorrect';
                resultText.innerHTML = `❌ 答錯了！正確答案是 ${correctAnswer}) ${correctOptionText}`;
            }
            
            resultPanel.style.display = 'block';
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function backToSetup() {
            document.getElementById('setupPanel').style.display = 'block';
            document.getElementById('quizPanel').style.display = 'none';
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = stats.correctCount;
            document.getElementById('totalAnswered').textContent = stats.totalAnswered;
            
            const accuracy = stats.totalAnswered > 0 ? 
                Math.round((stats.correctCount / stats.totalAnswered) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function shuffleQuestionOptions(question) {
            const options = [
                { letter: 'A', text: question.選項A || question['選項A'] },
                { letter: 'B', text: question.選項B || question['選項B'] },
                { letter: 'C', text: question.選項C || question['選項C'] },
                { letter: 'D', text: question.選項D || question['選項D'] }
            ];

            shuffleArray(options);

            const newQuestion = { ...question };
            const correctAnswer = question.正確答案 || question['正確答案'];
            
            options.forEach((option, index) => {
                const newLetter = ['A', 'B', 'C', 'D'][index];
                newQuestion['選項' + newLetter] = option.text;
                
                if (option.letter === correctAnswer) {
                    newQuestion.正確答案 = newLetter;
                }
            });

            return newQuestion;
        }

        // 載入完整題庫資料
        const fullQuestionsData = [
            {
                "題號": 24, "年份": 113, "學期": 2, "科目": "臨床血清免疫學與臨床病毒學", "主題分類": "C. 臨床免疫病理學",
                "題目內容": "下列有關自體免疫肝炎（autoimmune hepatitis）之敘述，何者正確？",
                "選項A": "好發於年輕男性", "選項B": "病人血中常能測到高價數的抗平滑肌抗體（anti-smooth muscle antibody）",
                "選項C": "病人血中常能測到高價數的抗粒線體抗體（anti-mitochondrial antibody）", "選項D": "病人血清中IgM抗體顯著增加",
                "正確答案": "B"
