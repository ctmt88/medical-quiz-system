<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«æª¢å¸«é¡Œåº«ç·´ç¿’å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .controls {
            padding: 30px;
            background: white;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus {
            border-color: #667eea;
            outline: none;
        }

        .start-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .quiz-container {
            display: none;
            padding: 30px;
        }

        .question-header {
            background: #f8f9fa;
            padding: 20px;
            border-left: 5px solid #667eea;
            margin-bottom: 25px;
            border-radius: 0 10px 10px 0;
        }

        .question-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .question-text {
            font-size: 1.3em;
            line-height: 1.6;
            color: #2c3e50;
            font-weight: 500;
        }

        .options {
            margin: 25px 0;
        }

        .option {
            display: block;
            background: #f8f9fa;
            margin: 10px 0;
            padding: 15px 20px;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            line-height: 1.5;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #5a6fd8;
        }

        .option.correct {
            background: #28a745;
            color: white;
            border-color: #23923d;
        }

        .option.incorrect {
            background: #dc3545;
            color: white;
            border-color: #c82333;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .result.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.incorrect {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .explanation {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 0 5px 5px 0;
            font-style: italic;
        }

        .progress {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§¬ é†«æª¢å¸«é¡Œåº«ç·´ç¿’</h1>
            <p>è‡¨åºŠè¡€æ¸…å…ç–«å­¸èˆ‡è‡¨åºŠç—…æ¯’å­¸å°ˆæ¥­é¡Œåº«</p>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalQuestions">80</div>
                <div class="stat-label">ç¸½é¡Œæ•¸</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="correctCount">0</div>
                <div class="stat-label">ç­”å°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalAnswered">0</div>
                <div class="stat-label">å·²ç­”é¡Œ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="accuracy">0%</div>
                <div class="stat-label">æ­£ç¢ºç‡</div>
            </div>
        </div>

        <div class="controls" id="setupPanel">
            <div class="control-group">
                <label for="excelFile">ğŸ“ é¸æ“‡Excelé¡Œåº«æª”æ¡ˆ</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin-bottom: 15px; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9fa;">
                <div id="fileStatus" style="color: #666; font-size: 0.9em; margin-bottom: 15px;">è«‹é¸æ“‡Excelæª”æ¡ˆè¼‰å…¥é¡Œåº«</div>
            </div>

            <div class="control-group">
                <label for="categoryFilter">é¸æ“‡ä¸»é¡Œåˆ†é¡</label>
                <select id="categoryFilter" disabled>
                    <option value="all">è«‹å…ˆè¼‰å…¥Excelæª”æ¡ˆ</option>
                </select>
            </div>

            <div class="control-group">
                <label for="practiceMode">ç·´ç¿’æ¨¡å¼</label>
                <select id="practiceMode">
                    <option value="random">éš¨æ©Ÿå‡ºé¡Œ</option>
                    <option value="sequential">é †åºç·´ç¿’</option>
                    <option value="shuffle_options">éš¨æ©Ÿé¸é …é †åº</option>
                </select>
            </div>

            <button class="start-btn" onclick="startQuiz()" id="startButton" disabled style="opacity: 0.5;">è«‹å…ˆè¼‰å…¥Excelæª”æ¡ˆ</button>
        </div>

        <div class="quiz-container" id="quizPanel">
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="question-header">
                <div class="question-info">
                    <span id="questionNumber">ç¬¬ 1 é¡Œ</span>
                    <span id="questionCategory">ä¸»é¡Œåˆ†é¡</span>
                </div>
                <div class="question-text" id="questionText"></div>
            </div>

            <div class="options" id="optionsContainer"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showAnswer()">æŸ¥çœ‹ç­”æ¡ˆ</button>
                <button class="btn btn-primary" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
                <button class="btn btn-secondary" onclick="backToSetup()">è¿”å›è¨­å®š</button>
            </div>

            <div class="result" id="resultPanel">
                <div id="resultText"></div>
                <div class="explanation" id="explanationText" style="display: none;">
                    ğŸ’¡ é€™é¡Œç›®å‰æ²’æœ‰è©³ç´°è§£æï¼Œä½†ä½ å¯ä»¥æ ¹æ“šé†«æª¢å°ˆæ¥­çŸ¥è­˜ä¾†ç†è§£ç­”æ¡ˆã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥SheetJSåº«ä¾†è®€å–Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let questionsData = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let showingAnswer = false;
        let stats = {
            totalAnswered: 0,
            correctCount: 0
        };

        // è™•ç†Excelæª”æ¡ˆä¸Šå‚³
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('excelFile');
            fileInput.addEventListener('change', handleFileUpload);
        });

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileStatus = document.getElementById('fileStatus');
            fileStatus.textContent = 'æ­£åœ¨è®€å–æª”æ¡ˆ...';
            fileStatus.style.color = '#667eea';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                questionsData = jsonData;
                
                // æ›´æ–°ç•Œé¢
                updateCategoryOptions();
                document.getElementById('totalQuestions').textContent = questionsData.length;
                
                // å•Ÿç”¨æ§åˆ¶é …
                document.getElementById('categoryFilter').disabled = false;
                document.getElementById('startButton').disabled = false;
                document.getElementById('startButton').style.opacity = '1';
                document.getElementById('startButton').textContent = 'é–‹å§‹ç·´ç¿’';
                
                fileStatus.textContent = `âœ… æˆåŠŸè¼‰å…¥ ${questionsData.length} é¡Œï¼`;
                fileStatus.style.color = '#28a745';
                
            } catch (error) {
                console.error('è®€å–æª”æ¡ˆå¤±æ•—:', error);
                fileStatus.textContent = 'âŒ æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯Excelæ ¼å¼';
                fileStatus.style.color = '#dc3545';
            }
        }

        function updateCategoryOptions() {
            const categories = {};
            questionsData.forEach(question => {
                const category = question.ä¸»é¡Œåˆ†é¡ || question['ä¸»é¡Œåˆ†é¡'];
                if (category) {
                    categories[category] = (categories[category] || 0) + 1;
                }
            });

            const select = document.getElementById('categoryFilter');
            select.innerHTML = `<option value="all">å…¨éƒ¨ä¸»é¡Œ (${questionsData.length}é¡Œ)</option>`;
            
            Object.entries(categories).forEach(([category, count]) => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${count}é¡Œ)`;
                select.appendChild(option);
            });
        }

        // åˆå§‹åŒ–
        async function initializeQuestions() {
            try {
                // å˜—è©¦å¾ä¸Šå‚³çš„Excelè®€å–è³‡æ–™
                const fileContent = await window.fs.readFile('æŠ½æ¨£80é¡Œ_å…ç–«40_ç—…æ¯’40.xlsx');
                const workbook = XLSX.read(fileContent);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // æ›´æ–°å…¨åŸŸé¡Œåº«
                questionsData.length = 0;
                questionsData.push(...jsonData);
                
                console.log('æˆåŠŸè¼‰å…¥', questionsData.length, 'é¡Œ');
            } catch (error) {
                console.log('ä½¿ç”¨å…§å»ºç¤ºä¾‹é¡Œåº«');
            }
        }

        function startQuiz() {
            if (questionsData.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³Excelæª”æ¡ˆï¼');
                return;
            }

            const category = document.getElementById('categoryFilter').value;
            const mode = document.getElementById('practiceMode').value;

            // ç¯©é¸é¡Œç›®
            if (category === 'all') {
                currentQuestions = [...questionsData];
            } else {
                currentQuestions = questionsData.filter(q => 
                    (q.ä¸»é¡Œåˆ†é¡ || q['ä¸»é¡Œåˆ†é¡']) === category
                );
            }

            if (currentQuestions.length === 0) {
                alert('é¸æ“‡çš„åˆ†é¡æ²’æœ‰é¡Œç›®ï¼');
                return;
            }

            // æ‡‰ç”¨æ¨¡å¼
            if (mode === 'random') {
                shuffleArray(currentQuestions);
            } else if (mode === 'shuffle_options') {
                // æ‰“äº‚é¸é …é †åºä½†ä¿æŒæ­£ç¢ºç­”æ¡ˆ
                currentQuestions = currentQuestions.map(q => shuffleQuestionOptions(q));
            }

            currentQuestionIndex = 0;
            selectedAnswer = null;
            showingAnswer = false;
            
            // é‡ç½®çµ±è¨ˆ
            stats = { totalAnswered: 0, correctCount: 0 };
            updateStats();

            // åˆ‡æ›ä»‹é¢
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('quizPanel').style.display = 'block';

            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                alert('æ‰€æœ‰é¡Œç›®éƒ½ç·´ç¿’å®Œäº†ï¼\n' + 
                      'ç¸½é¡Œæ•¸: ' + stats.totalAnswered + '\n' +
                      'ç­”å°: ' + stats.correctCount + '\n' +
                      'æ­£ç¢ºç‡: ' + Math.round((stats.correctCount / stats.totalAnswered) * 100) + '%');
                backToSetup();
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            selectedAnswer = null;
            showingAnswer = false;

            // æ›´æ–°é€²åº¦æ¢
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // é¡¯ç¤ºé¡Œç›®è³‡è¨Š
            document.getElementById('questionNumber').textContent = 
                `ç¬¬ ${currentQuestionIndex + 1} é¡Œ / å…± ${currentQuestions.length} é¡Œ`;
            document.getElementById('questionCategory').textContent = 
                question.ä¸»é¡Œåˆ†é¡ || question['ä¸»é¡Œåˆ†é¡'] || 'æœªåˆ†é¡';
            document.getElementById('questionText').textContent = 
                question.é¡Œç›®å…§å®¹ || question['é¡Œç›®å…§å®¹'] || '';

            // é¡¯ç¤ºé¸é …
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            ['A', 'B', 'C', 'D'].forEach(option => {
                const optionText = question['é¸é …' + option] || question[`é¸é …${option}`] || '';
                if (optionText) {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.textContent = `${option}) ${optionText}`;
                    optionElement.onclick = () => selectOption(option, optionElement);
                    optionsContainer.appendChild(optionElement);
                }
            });

            // éš±è—çµæœ
            document.getElementById('resultPanel').style.display = 'none';
        }

        function selectOption(option, element) {
            if (showingAnswer) return;

            // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // æ¨™è¨˜æ–°é¸æ“‡
            element.classList.add('selected');
            selectedAnswer = option;
        }

        function showAnswer() {
            if (!selectedAnswer) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼');
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            const correctAnswer = question.æ­£ç¢ºç­”æ¡ˆ || question['æ­£ç¢ºç­”æ¡ˆ'];
            const isCorrect = selectedAnswer === correctAnswer;
            
            showingAnswer = true;

            // æ›´æ–°çµ±è¨ˆ
            stats.totalAnswered++;
            if (isCorrect) {
                stats.correctCount++;
            }
            updateStats();

            // æ¨™è¨˜é¸é …
            document.querySelectorAll('.option').forEach((opt, index) => {
                const optionLetter = ['A', 'B', 'C', 'D'][index];
                
                if (optionLetter === correctAnswer) {
                    opt.classList.add('correct');
                } else if (optionLetter === selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                
                opt.style.pointerEvents = 'none';
            });

            // é¡¯ç¤ºçµæœ
            const resultPanel = document.getElementById('resultPanel');
            const resultText = document.getElementById('resultText');
            
            if (isCorrect) {
                resultPanel.className = 'result correct';
                resultText.innerHTML = 'ğŸ‰ ç­”å°äº†ï¼';
            } else {
                const correctOptionText = question['é¸é …' + correctAnswer] || question[`é¸é …${correctAnswer}`];
                resultPanel.className = 'result incorrect';
                resultText.innerHTML = `âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correctAnswer}) ${correctOptionText}`;
            }
            
            resultPanel.style.display = 'block';
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function backToSetup() {
            document.getElementById('setupPanel').style.display = 'block';
            document.getElementById('quizPanel').style.display = 'none';
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = stats.correctCount;
            document.getElementById('totalAnswered').textContent = stats.totalAnswered;
            
            const accuracy = stats.totalAnswered > 0 ? 
                Math.round((stats.correctCount / stats.totalAnswered) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function shuffleQuestionOptions(question) {
            const options = [
                { letter: 'A', text: question.é¸é …A || question['é¸é …A'] },
                { letter: 'B', text: question.é¸é …B || question['é¸é …B'] },
                { letter: 'C', text: question.é¸é …C || question['é¸é …C'] },
                { letter: 'D', text: question.é¸é …D || question['é¸é …D'] }
            ];

            shuffleArray(options);

            const newQuestion = { ...question };
            const correctAnswer = question.æ­£ç¢ºç­”æ¡ˆ || question['æ­£ç¢ºç­”æ¡ˆ'];
            
            options.forEach((option, index) => {
                const newLetter = ['A', 'B', 'C', 'D'][index];
                newQuestion['é¸é …' + newLetter] = option.text;
                
                if (option.letter === correctAnswer) {
                    newQuestion.æ­£ç¢ºç­”æ¡ˆ = newLetter;
                }
            });

            return newQuestion;
        }

        // è¼‰å…¥å®Œæ•´é¡Œåº«è³‡æ–™
        const fullQuestionsData = [
            {
                "é¡Œè™Ÿ": 24, "å¹´ä»½": 113, "å­¸æœŸ": 2, "ç§‘ç›®": "è‡¨åºŠè¡€æ¸…å…ç–«å­¸èˆ‡è‡¨åºŠç—…æ¯’å­¸", "ä¸»é¡Œåˆ†é¡": "C. è‡¨åºŠå…ç–«ç—…ç†å­¸",
                "é¡Œç›®å…§å®¹": "ä¸‹åˆ—æœ‰é—œè‡ªé«”å…ç–«è‚ç‚ï¼ˆautoimmune hepatitisï¼‰ä¹‹æ•˜è¿°ï¼Œä½•è€…æ­£ç¢ºï¼Ÿ",
                "é¸é …A": "å¥½ç™¼æ–¼å¹´è¼•ç”·æ€§", "é¸é …B": "ç—…äººè¡€ä¸­å¸¸èƒ½æ¸¬åˆ°é«˜åƒ¹æ•¸çš„æŠ—å¹³æ»‘è‚ŒæŠ—é«”ï¼ˆanti-smooth muscle antibodyï¼‰",
                "é¸é …C": "ç—…äººè¡€ä¸­å¸¸èƒ½æ¸¬åˆ°é«˜åƒ¹æ•¸çš„æŠ—ç²’ç·šé«”æŠ—é«”ï¼ˆanti-mitochondrial antibodyï¼‰", "é¸é …D": "ç—…äººè¡€æ¸…ä¸­IgMæŠ—é«”é¡¯è‘—å¢åŠ ",
                "æ­£ç¢ºç­”æ¡ˆ": "B"
